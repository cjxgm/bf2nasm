
/* bf2nasm - BrainFuck to nasm compiler */

#include <stdio.h>

int main(void)
{
	int ch;
	int loop = 0;
	int loops[0x10000] = {0};
	char lp = 0;

	puts(
			"; generated by bf2nasm, by eXerigumo Clanjor.\n"
			"\n"
			"[section .bss]\n"
			"mem:	resb 300000\n"
			"mp:		resd 1\n"
			"\n"
			"[section .text]\n"
			"[extern putchar]\n"
			"[extern getchar]\n"
			"main:\n"
		);

	while ((ch = getchar()) != EOF) {
		switch (ch) {
			case '+':
				puts(
						"\tmov		eax, dword [mp]\n"
						"\tinc		byte [mem+eax]"
					);
				break;
			case '-':
				puts(
						"\tmov		eax, [mp]\n"
						"\tdec		byte [mem+eax]"
					);
				break;
			case '>':
				puts("\tinc		dword [mp]");
				break;
			case '<':
				puts("\tdec		dword [mp]");
				break;
			case ',':
				puts(
						"\tcall	getchar\n"
						"\tmov		ebx, [mp]\n"
						"\tmov		[mem+ebx], al"
					);
				break;
			case '.':
				puts(
						"\tmov		eax, [mp]\n"
						"\tpush	dword[mem+eax]\n"
						"\tcall	putchar\n"
						"\tadd		esp, 4"
					);
				break;
			case '[':
				loops[lp] = loop++;
				puts(
						"\tmov		eax, [mp]\n"
						"\tcmp		byte [mem+eax], 0"
					);
				printf("\tje		label_%d_end\n", loops[lp]);
				printf("label_%d_start:\n", loops[lp]);
				lp++;
				break;
			case ']':
				lp--;
				printf("\tjmp		label_%d_start\n", loops[lp]);
				printf("label_%d_end:\n", loops[lp]);
				break;
		}
	}

	puts(
			"\n\txor		eax, eax\n"
			"ret\n"
		);

	return 0;
}

